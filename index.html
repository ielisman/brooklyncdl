<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brooklyn CDL ELDT Platform</title>
  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Retake Quiz Confirmation Modal -->
  <div id="retakeModal" class="retake-modal-overlay">
    <div class="retake-modal-box">
      <h3>‚ö†Ô∏è Reset Quiz Progress</h3>
      <p>Please note - You will lose your progress for this section.</p>
      <p style="font-weight: bold;">Press Confirm to Continue or Cancel otherwise.</p>
      <div class="retake-modal-buttons">
        <button class="retake-btn-confirm" onclick="confirmRetakeQuiz()">Confirm</button>
        <button class="retake-btn-cancel" onclick="cancelRetakeQuiz()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Authentication Modal -->
  <div id="authModal" class="auth-modal">
    <div class="auth-modal-content">
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showLogin()">Login</button>
        <button class="auth-tab" onclick="showSignup()">Sign Up</button>
      </div>
      
      <!-- Login Form -->
      <div id="loginForm" class="auth-form">
        <h2>Welcome Back</h2>
        <div class="form-group">
          <label for="loginEmail">Email *</label>
          <input type="email" id="loginEmail" required autocomplete="email">
          <div class="error-msg" id="loginEmailError"></div>
        </div>
        <div class="form-group">
          <label for="loginPassword">Password *</label>
          <div class="password-input-container">
            <input type="password" id="loginPassword" required>
            <span class="password-toggle" id="loginPasswordToggle" onclick="togglePasswordVisibility('loginPassword', 'loginPasswordToggle')">&#128065;</span>
          </div>
          <div class="error-msg" id="loginPasswordError"></div>
        </div>
        <button class="btn btn-primary auth-submit" onclick="handleLogin()">Sign In</button>
        <div class="auth-message" id="loginMessage"></div>
      </div>
      
      <!-- Signup Form -->
      <div id="signupForm" class="auth-form" style="display: none;">
        <h2>Create Your Account</h2>
        
        <!-- Name Row -->
        <div class="form-row">
          <div class="form-group">
            <label for="signupFirstName">First Name *</label>
            <input type="text" id="signupFirstName" required>
            <div class="error-msg" id="signupFirstNameError"></div>
          </div>
          <div class="form-group">
            <label for="signupLastName">Last Name *</label>
            <input type="text" id="signupLastName" required>
            <div class="error-msg" id="signupLastNameError"></div>
          </div>
        </div>

        <!-- DOB and License Row -->
        <div class="form-row">
          <div class="form-group">
            <label for="signupDob">Date of Birth *</label>
            <input type="date" id="signupDob" required>
            <div class="error-msg" id="signupDobError"></div>
          </div>
          <div class="form-group">
            <label for="signupLicenseNumber">License Number *</label>
            <input type="text" id="signupLicenseNumber" required>
            <div class="error-msg" id="signupLicenseNumberError"></div>
          </div>
        </div>

        <!-- State and Email Row -->
        <div class="form-row">
          <div class="form-group">
            <label for="signupState">State *</label>
            <input type="text" id="signupState" list="signupStates" required autocomplete="address-level1">
            <datalist id="signupStates">
            <option value="AL">Alabama</option>
            <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option>
            <option value="CA">California</option>
            <option value="CO">Colorado</option>
            <option value="CT">Connecticut</option>
            <option value="DE">Delaware</option>
            <option value="FL">Florida</option>
            <option value="GA">Georgia</option>
            <option value="HI">Hawaii</option>
            <option value="ID">Idaho</option>
            <option value="IL">Illinois</option>
            <option value="IN">Indiana</option>
            <option value="IA">Iowa</option>
            <option value="KS">Kansas</option>
            <option value="KY">Kentucky</option>
            <option value="LA">Louisiana</option>
            <option value="ME">Maine</option>
            <option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option>
            <option value="MI">Michigan</option>
            <option value="MN">Minnesota</option>
            <option value="MS">Mississippi</option>
            <option value="MO">Missouri</option>
            <option value="MT">Montana</option>
            <option value="NE">Nebraska</option>
            <option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option>
            <option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option>
            <option value="NY">New York</option>
            <option value="NC">North Carolina</option>
            <option value="ND">North Dakota</option>
            <option value="OH">Ohio</option>
            <option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option>
            <option value="PA">Pennsylvania</option>
            <option value="RI">Rhode Island</option>
            <option value="SC">South Carolina</option>
            <option value="SD">South Dakota</option>
            <option value="TN">Tennessee</option>
            <option value="TX">Texas</option>
            <option value="UT">Utah</option>
            <option value="VT">Vermont</option>
            <option value="VA">Virginia</option>
            <option value="WA">Washington</option>
            <option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option>
            <option value="WY">Wyoming</option>
            <option value="DC">District of Columbia</option>
            <option value="PR">Puerto Rico</option>
            <option value="VI">Virgin Islands</option>
            <option value="AS">American Samoa</option>
            <option value="GU">Guam</option>
            <option value="MP">Northern Mariana Islands</option>
          </datalist>
          <div class="error-msg" id="signupStateError"></div>
        </div>
        <div class="form-group">
          <label for="signupEmail">Email *</label>
          <input type="email" id="signupEmail" required onblur="validateEmail()">
          <div class="error-msg" id="signupEmailError"></div>
        </div>
      </div>

      <!-- Phone and Course Row -->
      <div class="form-row">
        <div class="form-group">
          <label for="signupPhone">Phone</label>
          <input type="tel" id="signupPhone" oninput="formatPhoneNumber(this)" onblur="validatePhone()" maxlength="14" placeholder="(123) 456-7890">
          <div class="error-msg" id="signupPhoneError"></div>
        </div>
        <div class="form-group">
          <label for="signupCourse">Course *</label>
          <input type="text" id="signupCourse" list="signupCourses" required>
          <datalist id="signupCourses">
          </datalist>
          <div class="error-msg" id="signupCourseError"></div>
        </div>
      </div>

      <!-- Password Row -->
      <div class="form-row">
        <div class="form-group">
          <label for="signupPassword">Create Password *</label>
          <div class="password-input-container">
            <input type="password" id="signupPassword" required>
            <span class="password-toggle" id="signupPasswordToggle" onclick="togglePasswordVisibility('signupPassword', 'signupPasswordToggle')">&#128065;</span>
          </div>
          <div class="error-msg" id="signupPasswordError"></div>
        </div>
        <div class="form-group">
          <label for="signupConfirmPassword">Confirm Password *</label>
          <div class="password-input-container">
            <input type="password" id="signupConfirmPassword" required>
            <span class="password-toggle" id="signupConfirmPasswordToggle" onclick="togglePasswordVisibility('signupConfirmPassword', 'signupConfirmPasswordToggle')">&#128065;</span>
          </div>
          <div class="error-msg" id="signupConfirmPasswordError"></div>
        </div>
      </div>

      <!-- Password Requirements (Full Width) -->
      <div class="password-requirements">
        Password must be at least 8 characters with uppercase, lowercase, number, and special character
      </div>
      
      <!-- Cloudflare Turnstile (hidden by default, shown after 5 failed attempts) -->
      <div id="turnstile-container" style="display: none; margin-top: 20px;">
        <div class="cf-turnstile" 
             data-sitekey="0x4AAAAAAChME4jObMJt5hmu" 
             data-theme="dark" 
             data-callback="onTurnstileSuccess"></div>
      </div>
      
        <button class="btn btn-primary auth-submit" onclick="handleSignup()">Create Account</button>
        <div class="auth-message" id="signupMessage"></div>
      </div>
    </div>
  </div>

  <button class="menu-toggle" onclick="toggleMobileMenu()" style="display:none">‚ò∞ Menu</button>

  <aside id="sidebar" style="display:none">
    <div class="sidebar-header" onclick="showHome()"><h3>ELDT CLASS A CDL THEORY</h3></div>
    <div class="global-score-box">
      <span>Overall Score</span>
      <strong id="globalCount">0 / 0 Correct</strong>
      <div id="pctBox" style="font-size: 1.1rem; margin-top: 5px; font-weight: bold;">0%</div>
      <div id="attemptedBox" class="attempted-text">Total Attempted: 0</div>
      <div class="pass-msg"><script>document.write(PASSING_PERCENTAGE)</script>% of correct answers are required based on the total number of questions in order to pass</div>
    </div>
    <nav id="sidebarNav"></nav>
  </aside>

  <main><div id="contentArea" class="container"></div></main>
  
  <button id="floatingSubmitBtn" class="floating-submit-btn" onclick="submitScores()" style="display:none">Submit Scores</button>

  <script>
    // Server-side configuration (environment variables handled by server)
    // No need for client-side API keys anymore!

    // Configuration Constants
    const PASSING_PERCENTAGE = 5; // Minimum percentage required to pass

    // Date formatting functions
    function formatDateOfBirth(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString; // Return original if invalid
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${months[date.getMonth()]}-${date.getDate()}-${date.getFullYear()}`;
    }

    function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      
      // Parse the date string directly without timezone conversion
      // Format: "2026-02-23 23:36:56.344859" or "2026-02-23T23:36:56.344859Z"
      const dateStr = dateString.replace('T', ' ').replace('Z', '').trim();
      const parts = dateStr.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2}):(\d{2})/);
      
      if (!parts) return 'N/A';
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const year = parts[1];
      const month = months[parseInt(parts[2]) - 1];
      const day = parseInt(parts[3]);
      let hours = parseInt(parts[4]);
      const minutes = parts[5];
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12; // Convert to 12-hour format
      
      return `${month} ${day}, ${year}, ${hours}:${minutes} ${ampm}`;
    }

    let currentQuizId = null;
    let currentQIndex = 0;
    let isAuthenticated = false; // Track authentication state
    let coursesMap = {}; // Map course names to course IDs
    let failedSignupAttempts = 0; // Track consecutive failed signup attempts for reCAPTCHA
    let userData = {
      id: null,
      firstName: '',
      lastName: '',
      dob: '',
      licenseNumber: '',
      state: '',
      email: '',
      phone: '',
      registerDate: '',
      startDate: '',
      lastQuizDate: '',
      submissionDate: '',
      userType: 'Student'
    };

    // Cloudflare Turnstile Functions
    function onTurnstileSuccess(token) {
      console.log('‚úÖ Turnstile verification successful');
    }

    function resetTurnstile() {
      const turnstileContainer = document.getElementById('turnstile-container');
      if (turnstileContainer) {
        turnstileContainer.style.display = 'none';
        // Reset the widget if it exists
        if (window.turnstile && window.turnstile.reset) {
          window.turnstile.reset();
        }
      }
    }

    // Authentication Functions
    function showLogin() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
      document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.auth-tab')[0].classList.add('active'); // Login tab is first
      clearAuthMessages();
    }

    function showSignup() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'block';
      document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.auth-tab')[1].classList.add('active'); // Signup tab is second
      clearAuthMessages();
      loadCourses(); // Load courses when signup form is shown
    }

    async function loadCourses() {
      try {
        const response = await fetch('/api/courses');
        const result = await response.json();
        
        if (result.success && result.courses) {
          const courseDatalist = document.getElementById('signupCourses');
          // Clear existing options
          courseDatalist.innerHTML = '';
          coursesMap = {}; // Clear existing mapping
          
          // Add course options
          result.courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course.name; // Use course name as value
            courseDatalist.appendChild(option);
            coursesMap[course.name] = course.id; // Store mapping
          });
        }
      } catch (error) {
        console.error('Error loading courses:', error);
        showError('signupCourseError', 'Failed to load courses. Please refresh the page.');
      }
    }

    function togglePasswordVisibility(inputId, iconId) {
      const passwordInput = document.getElementById(inputId);
      const eyeIcon = document.getElementById(iconId);
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.innerHTML = '&#128065;'; // Keep same eye icon
        eyeIcon.classList.add('active');
        eyeIcon.style.opacity = '0.5'; // Dim it to show it's active
      } else {
        passwordInput.type = 'password';
        eyeIcon.innerHTML = '&#128065;'; // Same eye icon
        eyeIcon.classList.remove('active');
        eyeIcon.style.opacity = '1'; // Full opacity for inactive
      }
    }

    function clearAuthMessages() {
      document.querySelectorAll('.auth-message').forEach(msg => {
        msg.style.display = 'none';
        msg.className = 'auth-message';
      });
      document.querySelectorAll('.error-msg').forEach(error => {
        error.style.display = 'none';
        error.textContent = '';
      });
    }

    function validateEmail() {
      const emailInput = document.getElementById('signupEmail');
      const email = emailInput.value.trim();
      const emailError = document.getElementById('signupEmailError');
      
      // Clear previous error
      emailError.style.display = 'none';
      emailError.textContent = '';
      
      if (email) {
        // Email regex pattern: alias@domain.extension
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(email)) {
          emailError.textContent = 'Wrong email format. Must be XX@YY.Z';
          emailError.style.display = 'block';
          return false;
        }
      }
      return true;
    }

    function formatPhoneNumber(input) {
      // Remove all non-digit characters
      let value = input.value.replace(/\D/g, '');
      
      // Limit to 10 digits
      value = value.substring(0, 10);
      
      // Format as (XXX) XXX-XXXX
      let formattedValue = '';
      if (value.length > 0) {
        formattedValue = '(' + value.substring(0, 3);
        if (value.length >= 3) {
          formattedValue += ') ' + value.substring(3, 6);
        }
        if (value.length >= 6) {
          formattedValue += '-' + value.substring(6, 10);
        }
      }
      
      input.value = formattedValue;
    }

    function validatePhone() {
      const phoneInput = document.getElementById('signupPhone');
      const phone = phoneInput.value.trim();
      const phoneError = document.getElementById('signupPhoneError');
      
      // Clear previous error
      phoneError.style.display = 'none';
      phoneError.textContent = '';
      
      if (phone && phone.length > 0) {
        // Remove formatting to check digit count
        const digitsOnly = phone.replace(/\D/g, '');
        
        if (digitsOnly.length > 0 && digitsOnly.length !== 10) {
          phoneError.textContent = 'Phone must be in format: (123) 456-7890';
          phoneError.style.display = 'block';
          return false;
        }
      }
      return true;
    }

    function showAuthMessage(elementId, message, isError = false) {
      const msgEl = document.getElementById(elementId);
      msgEl.textContent = message;
      msgEl.className = isError ? 'auth-message error' : 'auth-message success';
      msgEl.style.display = 'block';
    }

    function validateAuthPassword(password) {
      const minLength = 8;
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password);
      
      console.log('Password validation for:', password);
      console.log('Length >= 8:', password.length >= minLength);
      console.log('Has uppercase:', hasUpperCase);
      console.log('Has lowercase:', hasLowerCase);
      console.log('Has numbers:', hasNumbers);
      console.log('Has special char:', hasSpecialChar);
      
      return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar;
    }

    async function handleLogin() {
      clearAuthMessages();
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      // Basic validation
      if (!email) {
        showError('loginEmailError', 'Email is required');
        return;
      }
      if (!password) {
        showError('loginPasswordError', 'Password is required');
        return;
      }

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // Include cookies for authentication
          body: JSON.stringify({ email, password })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          isAuthenticated = true; // Set authentication state
          
          // Store token for VS Code browser fallback
          if (result.token) {
            localStorage.setItem('authToken', result.token);
          }
          
          updateActionBarVisibility();
          
          userData = {
            id: result.user.id,
            firstName: result.user.firstName,
            lastName: result.user.lastName,
            email: result.user.email,
            userType: result.user.userType,
            registerDate: result.user.registerDate // Use date from server
          };
          
          // Fetch full user profile to get dob, licenseNumber, state, phone
          try {
            const profileResponse = await fetch('/api/user/profile', {
              headers: {
                'X-Auth-Token': result.token || localStorage.getItem('authToken')
              },
              credentials: 'include'
            });
            
            if (profileResponse.ok) {
              const profileData = await profileResponse.json();
              userData.dob = profileData.dob || '';
              userData.licenseNumber = profileData.license_number || '';
              userData.state = profileData.state || '';
              userData.phone = profileData.phone || '';
              console.log('‚úÖ User profile loaded:', userData);
            }
          } catch (profileError) {
            console.warn('‚ö†Ô∏è Could not load full profile:', profileError);
          }
          
          showAuthMessage('loginMessage', 'Login successful! Loading your courses...', false);
          
          setTimeout(() => {
            hideAuthModal();
            showUserDashboard();
          }, 1500);
          
        } else {
          showAuthMessage('loginMessage', result.error || 'Login failed', true);
        }
      } catch (error) {
        console.error('Login error:', error);
        showAuthMessage('loginMessage', 'Connection error. Please try again.', true);
      }
    }

    async function handleSignup() {
      clearAuthMessages();
      
      const courseName = document.getElementById('signupCourse').value.trim();
      const courseId = coursesMap[courseName]; // Look up course ID from course name
      
      // Check if Turnstile is required and visible
      const turnstileContainer = document.getElementById('turnstile-container');
      if (turnstileContainer && turnstileContainer.style.display !== 'none') {
        const turnstileResponse = window.turnstile ? window.turnstile.getResponse() : null;
        if (!turnstileResponse) {
          showAuthMessage('signupMessage', 'Please complete the verification challenge', true);
          return;
        }
      }
      
      const formData = {
        firstName: document.getElementById('signupFirstName').value.trim(),
        lastName: document.getElementById('signupLastName').value.trim(),
        dob: document.getElementById('signupDob').value,
        licenseNumber: document.getElementById('signupLicenseNumber').value.trim(),
        state: document.getElementById('signupState').value.trim(),
        email: document.getElementById('signupEmail').value.trim(),
        phone: document.getElementById('signupPhone').value.trim(),
        courseId: courseId,
        password: document.getElementById('signupPassword').value,
        confirmPassword: document.getElementById('signupConfirmPassword').value
      };
      
      // Add Turnstile token if present
      const turnstileResponse = window.turnstile && window.turnstile.getResponse ? window.turnstile.getResponse() : null;
      if (turnstileResponse) {
        formData.turnstileToken = turnstileResponse;
      }

      // Validation
      let hasErrors = false;
      
      if (!formData.firstName) {
        showError('signupFirstNameError', 'First name is required');
        hasErrors = true;
      } else if (formData.firstName.length < 2) {
        showError('signupFirstNameError', 'First name must be at least 2 characters');
        hasErrors = true;
      }
      if (!formData.lastName) {
        showError('signupLastNameError', 'Last name is required');
        hasErrors = true;
      } else if (formData.lastName.length < 2) {
        showError('signupLastNameError', 'Last name must be at least 2 characters');
        hasErrors = true;
      }
      if (!formData.dob) {
        showError('signupDobError', 'Date of birth is required');
        hasErrors = true;
      }
      if (!formData.state) {
        showError('signupStateError', 'State is required');
        hasErrors = true;
      }
      if (!formData.email) {
        showError('signupEmailError', 'Email is required');
        hasErrors = true;
      }
      if (!formData.licenseNumber) {
        showError('signupLicenseNumberError', 'License number is required');
        hasErrors = true;
      } else if (formData.licenseNumber.length < 7) {
        showError('signupLicenseNumberError', 'License number must be at least 7 characters');
        hasErrors = true;
      }
      if (!courseName) {
        showError('signupCourseError', 'Course is required');
        hasErrors = true;
      } else if (!formData.courseId) {
        showError('signupCourseError', 'Please select a valid course from the list');
        hasErrors = true;
      }
      if (!formData.password) {
        showError('signupPasswordError', 'Password is required');
        hasErrors = true;
      } else if (!validateAuthPassword(formData.password)) {
        showError('signupPasswordError', 'Password must be at least 8 characters with uppercase, lowercase, number, and special character');
        hasErrors = true;
      }
      if (!formData.confirmPassword) {
        showError('signupConfirmPasswordError', 'Please confirm your password');
        hasErrors = true;
      } else if (formData.password !== formData.confirmPassword) {
        showError('signupConfirmPasswordError', 'Passwords do not match');
        hasErrors = true;
      }

      if (hasErrors) return;

      try {
        const response = await fetch('/api/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Store auth token if provided
          if (result.token) {
            localStorage.setItem('authToken', result.token);
          }
          
          // Set authentication state
          isAuthenticated = true;
          userData = {
            id: result.user.id,
            firstName: result.user.firstName,
            lastName: result.user.lastName,
            email: result.user.email,
            userType: 'Student',
            courseId: result.user.courseId
          };
          
          console.log('‚úÖ Signup successful - User data:', userData);
          
          // Hide auth modal and show course page
          hideAuthModal();
          showUserDashboard();
          
          // Reset failed attempts and Turnstile on successful signup
          failedSignupAttempts = 0;
          resetTurnstile();
          
        } else {
          // Check if error is about existing user
          if (result.error && result.error.includes('already exists')) {
            failedSignupAttempts++;
            console.log(`Failed signup attempts: ${failedSignupAttempts}`);
            
            if (failedSignupAttempts >= 3) {
              // Show Turnstile challenge
              const turnstileContainer = document.getElementById('turnstile-container');
              if (turnstileContainer) {
                turnstileContainer.style.display = 'block';
              }
              showAuthMessage('signupMessage', 'This account already exists. Please complete the verification below to continue.', true);
            } else {
              showAuthMessage('signupMessage', result.error, true);
            }
          } else {
            failedSignupAttempts = 0; // Reset on other errors
            resetTurnstile();
            showAuthMessage('signupMessage', result.error || 'Registration failed', true);
          }
        }
      } catch (error) {
        console.error('Signup error:', error);
        showAuthMessage('signupMessage', 'Connection error. Please try again.', true);
      }
    }

    function hideAuthModal() {
      document.getElementById('authModal').style.display = 'none';
    }

    async function checkAuthStatus() {
      try {
        const authToken = localStorage.getItem('authToken');
        const requestOptions = {
          credentials: 'include' // Include cookies for authentication
        };
        
        // Add fallback header for VS Code browser
        if (authToken) {
          requestOptions.headers = {
            'X-Auth-Token': authToken
          };
        }
        
        const response = await fetch('/api/auth/status', requestOptions);
        
        if (response.ok) {
          const result = await response.json();
          if (result.authenticated) {
            isAuthenticated = true; // Set authentication state
            userData = {
              id: result.user.userId,
              firstName: result.user.firstName,
              lastName: result.user.lastName,
              email: result.user.email,
              userType: result.user.userType,
              registerDate: result.user.registerDate // Use date from server
            };
            
            // Fetch full user profile to get dob, licenseNumber, state, phone
            try {
              const profileResponse = await fetch('/api/user/profile', {
                headers: authToken ? { 'X-Auth-Token': authToken } : {},
                credentials: 'include'
              });
              
              if (profileResponse.ok) {
                const profileData = await profileResponse.json();
                userData.dob = profileData.dob || '';
                userData.licenseNumber = profileData.license_number || '';
                userData.state = profileData.state || '';
                userData.phone = profileData.phone || '';
                console.log('‚úÖ User profile loaded on auth check:', userData);
              }
            } catch (profileError) {
              console.warn('‚ö†Ô∏è Could not load full profile on auth check:', profileError);
            }
            
            updateActionBarVisibility();
            hideAuthModal();
            showUserDashboard();
            return true;
          }
        }
      } catch (error) {
        console.log('Not authenticated:', error);
      }
      
      // Show auth modal if not authenticated
      document.getElementById('authModal').style.display = 'flex';
      return false;
    }

    // Initialize authentication on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadCourses(); // Preload courses for signup form
      checkAuthStatus();
    });

    // User Dashboard Function
    function showUserDashboard() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) {
        sidebar.style.display = 'none';
      }
      const menuToggle = document.querySelector('.menu-toggle');
      if (menuToggle) {
        menuToggle.style.display = 'none';
      }
      activeCourseId = null;
      const contentArea = document.getElementById('contentArea');
      
      // Check if user is admin to show Admin Dashboard link
      const adminDashboardSection = userData.userType === 'Admin' ? `
        <div class="content-section" style="margin-bottom: 30px;">
          <a href="admin-dashboard.html" style="
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            üõ†Ô∏è Admin Dashboard
          </a>
          <p style="color: #888; margin-top: 10px; font-size: 14px;">
            Manage students, company information, and admin users
          </p>
        </div>
      ` : '';
      
      contentArea.innerHTML = `
        <div class="quiz-card">
          <div class="quiz-header">
            <h2>Welcome, ${userData.firstName} ${userData.lastName}!</h2>
            <button class="btn btn-outline" onclick="logout()" style="margin-left: auto;">Logout</button>
          </div>
          ${adminDashboardSection}
          <div class="content-section">
            <h3>Your Assigned Courses</h3>
            <div id="assignedCourses">
              <div class="loading">Loading your courses...</div>
            </div>
          </div>
        </div>
      `;

      loadUserCourses();
    }

    async function loadUserCourses() {
      try {
        console.log('üîÑ Loading user courses...');
        console.log('üîí Auth state:', isAuthenticated);
        console.log('üë§ User data:', userData);
        
        const authToken = localStorage.getItem('authToken');
        const requestOptions = {
          credentials: 'include', // Include cookies for authentication
          headers: {
            'Cache-Control': 'no-cache'
          }
        };
        
        // Add fallback header for VS Code browser
        if (authToken) {
          requestOptions.headers['X-Auth-Token'] = authToken;
        }

        const response = await fetch('/api/user/courses', requestOptions);
        console.log('üì° API Response status:', response.status);
        console.log('üì° API Response headers:', Object.fromEntries(response.headers));
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå API Error:', response.status, errorText);
          throw new Error(`Failed to load courses: ${response.status} ${errorText}`);
        }

        const courses = await response.json();
        console.log('üìö Loaded courses:', courses);
        
        const coursesContainer = document.getElementById('assignedCourses');

        if (courses.length === 0) {
          console.log('üìã No courses found for user');
          coursesContainer.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--muted);">
              <h4>No Courses Assigned</h4>
              <p>Please contact your administrator to get assigned to courses.</p>
            </div>
          `;
        } else {
          console.log('‚úÖ Rendering', courses.length, 'courses');
          console.log('üìä Course data:', courses);
          coursesContainer.innerHTML = courses.map(course => {
            const percentage = course.completion_percentage || 0;
            console.log(`Course ${course.name}: ${percentage}% (${course.correct_answers}/${course.total_questions})`);
            return `
            <div class="course-card" style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--border); cursor: pointer;" onclick="startCourse(${course.id}, '${course.name}')">
              <h4 style="margin: 0 0 10px 0; color: var(--text);">${course.name} - <span style="color: ${percentage >= PASSING_PERCENTAGE ? 'var(--accent)' : 'var(--primary)'};">${percentage}% completed</span></h4>
              <p style="margin: 0; color: var(--muted);">${course.description || 'Click to start this course'}</p>
            </div>
          `;
          }).join('');
        }
      } catch (error) {
        console.error('üí• Error loading courses:', error);
        console.error('üí• Error details:', error.message, error.stack);
        document.getElementById('assignedCourses').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--danger);">
            <h4>Error Loading Courses</h4>
            <p>Please try refreshing the page or contact support.</p>
          </div>
        `;
      }
    }

    async function startCourse(courseId, courseName) {
      try {
        console.log('üöÄ Starting course:', courseId, courseName);
        activeCourseId = courseId;
        console.log('üîç User authenticated:', isAuthenticated);
        console.log('üë§ User data:', userData);
        
        // Show the sidebar and course content
        document.getElementById('sidebar').style.display = 'flex';
        console.log('‚úÖ Showed sidebar');
        
        if (window.innerWidth <= 768) {
          document.querySelector('.menu-toggle').style.display = 'block';
        }
        console.log('‚úÖ Ready to show submit button based on score');
        
        // Initialize the course
        console.log('üîÑ Initializing sidebar...');
        initSidebar();
        console.log('‚úÖ Initialized sidebar');
        
        console.log('üîÑ Showing home...');
        showHome();
        console.log('‚úÖ Showed home');
        
        console.log('üéâ Course started successfully');
        
      } catch (error) {
        console.error('üí• Error starting course:', error);
        console.error('üí• Error details:', error.message, error.stack);
        alert('Error starting course. Please try again.');
      }
    }

    async function logout() {
      try {
        const response = await fetch('/api/logout', { 
          method: 'POST',
          credentials: 'include' // Include cookies for authentication
        });
        
        if (response.ok) {
          isAuthenticated = false; // Reset authentication state
          localStorage.removeItem('authToken'); // Clear stored token
          userData = {
            id: null,
            firstName: '',
            lastName: '',
            dob: '',
            licenseNumber: '',
            state: '',
            email: '',
            phone: '',
            registerDate: '',
            startDate: '',
            lastQuizDate: '',
            submissionDate: '',
            userType: 'Student'
          };
          
          // Hide course content
          document.getElementById('sidebar').style.display = 'none';
          const submitScoresBtn = document.getElementById('submitScoresBtn');
          const floatingSubmitBtn = document.getElementById('floatingSubmitBtn');
          const certificateBtn = document.getElementById('certificateBtn');
          
          if (submitScoresBtn) {
            submitScoresBtn.style.display = 'none';
          }
          if (floatingSubmitBtn) {
            floatingSubmitBtn.style.display = 'none';
          }
          if (certificateBtn) {
            certificateBtn.style.display = 'none';
          }
          
          // Clear signup form fields
          document.getElementById('signupFirstName').value = '';
          document.getElementById('signupLastName').value = '';
          document.getElementById('signupDob').value = '';
          document.getElementById('signupLicenseNumber').value = '';
          document.getElementById('signupState').value = '';
          document.getElementById('signupEmail').value = '';
          document.getElementById('signupPhone').value = '';
          document.getElementById('signupCourse').value = '';
          document.getElementById('signupPassword').value = '';
          document.getElementById('signupConfirmPassword').value = '';
          
          // Clear login password field
          document.getElementById('loginPassword').value = '';
          
          // Clear any error messages
          clearAuthMessages();
          
          // Show auth modal with login tab
          document.getElementById('authModal').style.display = 'flex';
          showLogin(); // Switch to login tab
        }
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId);
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    async function submitScores() {
      // Create submission date in local timezone format (matching database format)
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const submissionDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      
      // Fetch user profile data and scores from server
      try {
        const authToken = localStorage.getItem('authToken');
        
        // Fetch user profile
        const profileResponse = await fetch('/api/user/profile', {
          headers: authToken ? { 'X-Auth-Token': authToken } : {},
          credentials: 'include'
        });
        
        if (!profileResponse.ok) {
          alert('Unable to fetch your profile. Please try again.');
          return;
        }
        
        const profile = await profileResponse.json();
        
        // Fetch progress data
        const progressUrl = `/api/user/course-progress?courseId=${activeCourseId || 1}`;
        const progressResponse = await fetch(progressUrl, {
          headers: authToken ? { 'X-Auth-Token': authToken } : {},
          credentials: 'include'
        });
        
        if (!progressResponse.ok) {
          alert('Unable to fetch your scores. Please try again.');
          return;
        }
        
        const progressData = await progressResponse.json();
        const totalCorrect = progressData.overall.total_score;
        const totalPossible = progressData.overall.total_questions;
        const score = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
        
        const emailBody = `ELDT Class A CDL Theory
Student: ${profile.first_name} ${profile.last_name} (DOB: ${formatDateOfBirth(profile.dob)} License: ${profile.state} ${profile.license_number})
Email: ${profile.email} Phone: ${profile.phone || 'N/A'}
Registered: ${formatDateTime(profile.registration_date)} 
Score Submitted On: ${formatDateTime(submissionDate)}
Final Score: ${totalCorrect} / ${totalPossible} Correct (${score}%) - ${score >= PASSING_PERCENTAGE ? 'PASSED' : 'NOT PASSED'}
        `.trim();
        
        const recipient = "info@brooklyncdl.com";
        const subject = encodeURIComponent("ELDT Score Submission");
        
        // Create properly formatted email body with HTML formatting
        // Generate section results from server data
        let sectionResultsHtml = `
          <div style="margin: 20px 0;">
            <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #3498db; padding-bottom: 5px;">
              üìä Section Results
            </h4>
            <div style="display: grid; gap: 10px;">
        `;
        
        let sectionResultsText = 'Section Results:\n';
        
        progressData.sections.forEach((section) => {
          const sectionTitle = section.section_name;
          const sectionTotal = section.total_questions;
          const sectionCorrect = section.score;
          const sectionPercent = sectionTotal > 0 ? Math.round((sectionCorrect / sectionTotal) * 100) : 0;
          const sectionStatus = sectionPercent >= PASSING_PERCENTAGE ? 'PASSED' : 'NOT PASSED';
          const statusColor = sectionPercent >= PASSING_PERCENTAGE ? '#27ae60' : '#e74c3c';
          const statusIcon = sectionPercent >= PASSING_PERCENTAGE ? '‚úÖ' : '‚ùå';
          
          sectionResultsHtml += `
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                        border-radius: 8px; padding: 15px; border-left: 4px solid ${statusColor};
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h5 style="margin: 0; color: #2c3e50; font-size: 16px; font-weight: 600;">
                  ${statusIcon} ${sectionTitle}
                </h5>
                <span style="background: ${statusColor}; color: white; padding: 4px 12px; 
                             border-radius: 20px; font-size: 12px; font-weight: bold;">
                  ${sectionStatus}
                </span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: #7f8c8d; font-size: 14px;">
                  Score: <strong style="color: #2c3e50;">${sectionCorrect} / ${sectionTotal}</strong>
                </span>
                <div style="background: #ecf0f1; border-radius: 10px; padding: 4px 8px;">
                  <span style="color: ${statusColor}; font-weight: bold; font-size: 14px;">
                    ${sectionPercent}%
                  </span>
                </div>
              </div>
            </div>
          `;
          
          sectionResultsText += `  ${sectionTitle}: ${sectionCorrect} / ${sectionTotal} correct (${sectionPercent}%) - ${sectionStatus}\n`;
        });
        
        sectionResultsHtml += '</div></div>';

        const finalStatus = score >= PASSING_PERCENTAGE ? 'PASSED' : 'NOT PASSED';
        const finalStatusColor = score >= PASSING_PERCENTAGE ? '#27ae60' : '#e74c3c';
        const finalStatusIcon = score >= PASSING_PERCENTAGE ? 'üéâ' : '‚ö†Ô∏è';

        const emailBodyHtml = `
          <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                      max-width: 600px; margin: 0 auto; background: #ffffff;">
            
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; padding: 30px 20px; text-align: center; border-radius: 12px 12px 0 0;">
              <h1 style="margin: 0; font-size: 28px; font-weight: 300; letter-spacing: 1px;">
                üöõ ELDT Score Submission
              </h1>
              <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 16px;">
                Class A CDL Theory Training Results
              </p>
            </div>

            <!-- Content -->
            <div style="padding: 30px 20px; background: white;">
              
              <!-- Student Info Card -->
              <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 25px;
                          border: 1px solid #e9ecef;">
                <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                  üë§ Student Information
                </h3>
                <div style="display: grid; gap: 8px;">
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                    <span style="color: #7f8c8d; font-weight: 500;">Student:</span>
                    <span style="color: #2c3e50; font-weight: 600;">${profile.first_name} ${profile.last_name}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                    <span style="color: #7f8c8d; font-weight: 500;">Date of Birth:</span>
                    <span style="color: #2c3e50; font-weight: 600;">${formatDateOfBirth(profile.dob)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                    <span style="color: #7f8c8d; font-weight: 500;">License ID:</span>
                    <span style="color: #2c3e50; font-weight: 600;">${profile.state} ${profile.license_number}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                    <span style="color: #7f8c8d; font-weight: 500;">Email:</span>
                    <span style="color: #2c3e50; font-weight: 600;">${profile.email}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                    <span style="color: #7f8c8d; font-weight: 500;">Phone:</span>
                    <span style="color: #2c3e50; font-weight: 600;">${profile.phone || 'N/A'}</span>
                  </div>
                </div>
              </div>

              <!-- Timeline -->
              <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 25px;
                          border: 1px solid #e9ecef;">
                <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 20px; display: flex; align-items: center;">
                  ‚è∞ Timeline
                </h3>
                <div style="display: grid; gap: 8px;">
                  <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e9ecef;">
                    <span style="color: #7f8c8d; font-weight: 500;">Registered:</span>
                    <span style="color: #2c3e50; font-weight: 600;">${formatDateTime(profile.registration_date)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                    <span style="color: #7f8c8d; font-weight: 500;">Submitted:</span>
                    <span style="color: #2c3e50; font-weight: 600;">${formatDateTime(submissionDate)}</span>
                  </div>
                </div>
              </div>
              
              ${sectionResultsHtml}
              
              <!-- Final Score Card -->
              <div style="background: linear-gradient(135deg, ${finalStatusColor} 0%, ${finalStatusColor}dd 100%); 
                          color: white; border-radius: 12px; padding: 25px; text-align: center; 
                          box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-top: 25px;">
                <div style="font-size: 48px; margin-bottom: 10px;">${finalStatusIcon}</div>
                <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 300;">Final Result</h2>
                <div style="font-size: 36px; font-weight: bold; margin: 15px 0;">
                  ${totalCorrect} / ${totalPossible}
                </div>
                <div style="font-size: 28px; font-weight: 600; margin: 10px 0;">
                  ${score}%
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 25px; padding: 12px 24px; 
                           display: inline-block; margin-top: 15px;">
                  <span style="font-size: 18px; font-weight: bold; letter-spacing: 1px;">
                    ${finalStatus}
                  </span>
                </div>
              </div>

            </div>

            <!-- Footer -->
            <div style="background: #2c3e50; color: #bdc3c7; padding: 20px; text-align: center; 
                        border-radius: 0 0 12px 12px; font-size: 14px;">
              <p style="margin: 0;">
                Brooklyn CDL ELDT Training Program<br>
                <span style="opacity: 0.8;">Professional Driver Education & Certification</span>
              </p>
            </div>

          </div>
        `;

        // Plain text version for fallback
        const emailBodyText = `Score Submission Summary:

ELDT Class A CDL Theory

Student: ${profile.first_name} ${profile.last_name} (DOB: ${formatDateOfBirth(profile.dob)} License: ${profile.state} ${profile.license_number})
Email: ${profile.email}
Phone: ${profile.phone || 'N/A'}
Registered: ${formatDateTime(profile.registration_date)}
Score Submitted On: ${formatDateTime(submissionDate)}

${sectionResultsText}
Final Score: ${totalCorrect} / ${totalPossible} Correct (${score}%) - ${score >= PASSING_PERCENTAGE ? 'PASSED' : 'NOT PASSED'}
        `;

        // Send email via Mailgun
        sendEmailViaMailgun(emailBodyHtml, emailBodyText);
        
        // Save results to file
        saveResults(emailBodyHtml, profile.license_number, profile.state, profile.first_name, profile.last_name);
        
        // Submit final results to database (await so DB write completes before showing modal)
        await submitFinalResultsToDatabase(activeCourseId || 1, totalCorrect, totalPossible, score);
        
        // Show confirmation to user
        showEmailConfirmation(emailBodyHtml);
        
      } catch (progressError) {
        console.error('Error fetching progress data:', progressError);
        alert('Unable to fetch your scores. Please try again.');
      }
    }

    // Submit final results to Results table in database
    async function submitFinalResultsToDatabase(courseId, totalScore, totalPossible, scorePercentage) {
      try {
        const authToken = localStorage.getItem('authToken');
        const response = await fetch('/api/submit-final-results', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Auth-Token': authToken
          },
          credentials: 'include',
          body: JSON.stringify({
            courseId: courseId,
            totalScore: totalScore,
            totalPossible: totalPossible,
            scorePercentage: scorePercentage,
            passed: scorePercentage >= PASSING_PERCENTAGE
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          console.log('‚úÖ Final results saved to database:', result);
        } else {
          console.error('‚ö†Ô∏è Failed to save results to database:', result.error);
        }
      } catch (error) {
        console.error('‚ùå Error submitting final results to database:', error);
      }
    }

    // Certificate download function (placeholder for future implementation)
    function downloadCertificate() {
      alert('Certificate download feature is coming soon! You have passed the course with 80% or higher.');
      // TODO: Implement certificate generation and download
      // This could call an API endpoint like /api/user/certificate
      // and download a PDF certificate
    }

    // Mailgun email sending function (now uses server-side API)
    async function sendEmailViaMailgun(htmlContent, textContent) {
      try {
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            htmlContent: htmlContent,
            textContent: textContent,
            subject: 'ELDT Score Submission'
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          console.log('Email sent successfully:', result);
          showSuccessMessage('Email sent successfully!');
        } else {
          console.error('Failed to send email:', result.error);
          showErrorMessage('Failed to send email. Please try again or contact support.');
        }
      } catch (error) {
        console.error('Error sending email:', error);
        showErrorMessage('Error sending email. Please check your connection and try again.');
      }
    }

    // Save results to file function (uses server-side API)
    async function saveResults(htmlContent, licenseNumber, state, firstName, lastName) {
      try {
        const response = await fetch('/api/saveResults', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            htmlContent: htmlContent,
            licenseNumber: licenseNumber,
            state: state,
            firstName: firstName,
            lastName: lastName,
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          console.log('Results saved successfully:', result);
          showSuccessMessage('Results saved successfully!');
          return true;
        } else {
          console.error('Failed to save results:', result.error);
          showErrorMessage('Failed to save results. Please try again or contact support.');
          return false;
        }
      } catch (error) {
        console.error('Error saving results:', error);
        showErrorMessage('Error saving results. Please check your connection and try again.');
        return false;
      }
    }

    // Show email confirmation with HTML formatting
    function showEmailConfirmation(htmlContent) {
      const displayDiv = document.createElement('div');
      displayDiv.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                    align-items: center; justify-content: center; backdrop-filter: blur(5px);">
          <div style="background: white; border-radius: 16px; max-width: 90%; max-height: 90%; 
                      overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
                      animation: modalSlideIn 0.3s ease-out;">
            
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; padding: 25px 30px; text-align: center; border-radius: 16px 16px 0 0;">
              <h2 style="margin: 0; font-size: 24px; font-weight: 300; display: flex; 
                         align-items: center; justify-content: center; gap: 10px;">
                <span style="font-size: 28px;">üìß</span>
                ELDT Class A Theory
              </h2>

            </div>

            <!-- Content -->
            <div style="padding: 20px 30px; max-height: 500px; overflow-y: auto;">
              ${htmlContent}
            </div>

            <!-- Footer -->
            <div style="padding: 20px 30px; background: #f8f9fa; border-radius: 0 0 16px 16px; 
                        text-align: center; border-top: 1px solid #e9ecef;">
              <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove(); showHome();" 
                      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                             color: white; border: none; border-radius: 25px; padding: 12px 30px; 
                             font-size: 16px; font-weight: 500; cursor: pointer; 
                             box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                             transition: all 0.3s ease;"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                ‚úì Close Preview
              </button>
            </div>

          </div>
        </div>

        <style>
          @keyframes modalSlideIn {
            from {
              opacity: 0;
              transform: scale(0.9) translateY(-50px);
            }
            to {
              opacity: 1;
              transform: scale(1) translateY(0);
            }
          }
        </style>
      `;
      document.body.appendChild(displayDiv);
    }

    // Show success message
    function showSuccessMessage(message) {
      const alertDiv = document.createElement('div');
      alertDiv.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; 
                    padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
                    z-index: 10001; font-family: Arial, sans-serif;">
          <strong>‚úì ${message}</strong>
        </div>
      `;
      document.body.appendChild(alertDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.parentNode.removeChild(alertDiv);
        }
      }, 5000);
    }

    // Show error message
    function showErrorMessage(message) {
      const alertDiv = document.createElement('div');
      alertDiv.innerHTML = `
        <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; 
                    padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
                    z-index: 10001; font-family: Arial, sans-serif;">
          <strong>‚úó ${message}</strong>
          <button onclick="this.parentElement.parentElement.remove()" 
                  style="background: none; border: none; color: white; font-size: 18px; 
                         float: right; margin-left: 10px; cursor: pointer;">&times;</button>
        </div>
      `;
      document.body.appendChild(alertDiv);
    }

    function toggleMobileMenu() {
      document.getElementById('sidebar').classList.toggle('mobile-open');
    }
    
    function closeMobileMenu() {
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('mobile-open');
      }
    }

    function initSidebar() {
      // If user is authenticated, load from database instead of hardcoded data
      if (isAuthenticated) {
        loadCourseFromDatabase();
        return;
      }
      
      // No fallback - authentication required
      console.log('‚ùå User not authenticated - cannot load sections');
    }

    function toggleMenu(id) {
      document.querySelectorAll('.sub-menu').forEach(m => m.id !== id && m.classList.remove('active'));
      const menu = document.getElementById(id);
      if(menu) menu.classList.toggle('active');
    }

    function updateActionBarVisibility() {
      const actionBar = document.getElementById('globalActionBar');
      if (!actionBar) return;
      actionBar.style.display = isAuthenticated ? 'flex' : 'none';
    }

    async function fetchUserDashboardInfo() {
      if (!isAuthenticated) {
        return null;
      }
      try {
        const authToken = localStorage.getItem('authToken');
        const requestOptions = {
          credentials: 'include'
        };
        if (authToken) {
          requestOptions.headers = {
            'X-Auth-Token': authToken
          };
        }
        const response = await fetch('/api/user/dashboard-info', requestOptions);
        if (!response.ok) {
          throw new Error(`Failed to load dashboard info (${response.status})`);
        }
        return await response.json();
      } catch (error) {
        console.error('üí• Error fetching dashboard info:', error);
        return null;
      }
    }

    async function showHome() {
      currentQuizId = null;
      closeMobileMenu();
      
      const dashboardInfo = await fetchUserDashboardInfo();
      if (dashboardInfo) {
        if (dashboardInfo.registrationDate) {
          userData.registerDate = dashboardInfo.registrationDate;
        }
        userData.lastQuizDate = dashboardInfo.lastQuizDate || '';
        if (dashboardInfo.submissionDate) {
          userData.submissionDate = dashboardInfo.submissionDate;
        }
      }

      const registrationDisplay = userData.registerDate
        ? formatDateTime(userData.registerDate)
        : 'Not available';
      const lastQuizDisplay = userData.lastQuizDate
        ? formatDateTime(userData.lastQuizDate)
        : (isAuthenticated ? 'No quiz activity yet' : 'Login to view');
      const submissionDisplay = userData.submissionDate
        ? formatDateTime(userData.submissionDate)
        : 'Pending final review';

      document.getElementById('contentArea').innerHTML = `
        <div class="home-dashboard">
          <div class="home-welcome">
            <h1>Welcome, ${userData.firstName} ${userData.lastName}</h1>
            <p>Select a section on the left to start your training.</p>
          </div>
          <div class="info-section">
            <div class="info-header">
              <div>
                <h3>Your Information</h3>
                <p>Track your enrollment timeline and assessment activity.</p>
              </div>
            </div>
            <div class="info-grid">
              <div class="info-card">
                <span class="info-label">Registration Date</span>
                <span class="info-value">${registrationDisplay}</span>
                <span class="info-hint">Official enrollment timestamp</span>
              </div>
              <div class="info-card">
                <span class="info-label">Last Quiz Date</span>
                <span class="info-value">${lastQuizDisplay}</span>
                <span class="info-hint">Updates whenever you answer a quiz question</span>
              </div>
              <div class="info-card">
                <span class="info-label">Submission Date</span>
                <span class="info-value">${submissionDisplay}</span>
                <span class="info-hint">Populated after final score submission</span>
              </div>
            </div>
          </div>
          <div class="payment-card" style="display:none;">
            <div class="payment-card-header">
              <div>
                <h3>Payment Information</h3>
                <p>Stripe integration coming soon. These fields will auto-fill once tuition is processed.</p>
              </div>
              <span class="payment-status">Awaiting transaction</span>
            </div>
            <div class="payment-grid">
              <div class="payment-field">
                <span class="payment-label">Transaction Number</span>
                <span class="payment-value">TBD</span>
              </div>
              <div class="payment-field">
                <span class="payment-label">Transaction Date</span>
                <span class="payment-value">Not yet processed</span>
              </div>
              <div class="payment-field">
                <span class="payment-label">Description</span>
                <span class="payment-value">Stripe payment placeholder</span>
              </div>
              <div class="payment-field">
                <span class="payment-label">Payment Method</span>
                <span class="payment-value">Stripe (pending)</span>
              </div>
              <div class="payment-field">
                <span class="payment-label">Price</span>
                <span class="payment-value">$0.00</span>
              </div>
            </div>
            <p class="payment-note">Need to add a payment? Your secure link will appear here once enabled.</p>
          </div>
          ${isAuthenticated ? `
          <div id="globalActionBar" class="global-action-bar">
            <button class="global-action-btn" onclick="showUserDashboard()">Main Menu</button>
            <button class="global-action-btn" onclick="logout()">Logout</button>
            <button id="submitScoresBtn" class="global-action-btn" onclick="submitScores()" style="display:none">Submit Scores</button>
            <button id="certificateBtn" class="global-action-btn" onclick="downloadCertificate()" style="display:none" title="Available after passing with 80%">Certificate</button>
          </div>
          ` : ''}
        </div>`;
      
      // Update display to show submit button if score >= 80%
      await updateGlobalDisplay();
      
      // Hide floating button on dashboard since it's already in the menu
      const floatingSubmitBtn = document.getElementById('floatingSubmitBtn');
      if (floatingSubmitBtn) {
        floatingSubmitBtn.style.display = 'none';
      }
      
      updateActionBarVisibility();
    }

    function showContent(id) {
      // Redirect to the new database content function
      showDatabaseContent(id);
    }

    // Load content from database instead of hardcoded function
    async function showDatabaseContent(sectionId) {
      console.log(`üîç [CONTENT] Loading database content for section ${sectionId}`);
      
      try {
        // Check authentication
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          console.error('‚ùå [CONTENT] No authentication token found');
          alert('Please log in again to view content.');
          return;
        }
        
        // Show loading indicator
        console.log('üîç [CONTENT] Setting up content area');
        const contentArea = document.getElementById('contentArea');
        if (contentArea) {
          contentArea.innerHTML = '<div class="loading">Loading section content...</div>';
          contentArea.style.display = 'block';
          console.log('‚úÖ [CONTENT] Content area prepared');
        } else {
          console.error('‚ùå [CONTENT] Content area element not found');
          alert('Content area not found. Please refresh the page.');
          return;
        }
        
        const requestOptions = {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-Auth-Token': authToken,
            'Cache-Control': 'no-cache'
          },
          credentials: 'omit',
          cache: 'no-cache'
        };
        
        console.log(`üì° [CONTENT] Fetching from /api/section/${sectionId}/content`);
        console.log('üì° [CONTENT] Request options:', requestOptions);
        
        const response = await fetch(`/api/section/${sectionId}/content`, requestOptions);
        
        console.log(`üì° [CONTENT] Response status: ${response.status}`);
        console.log('üì° [CONTENT] Response headers:', Object.fromEntries(response.headers));
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error(`üí• [CONTENT] API Error (${response.status}):`, errorText);
          throw new Error(`Failed to load content: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ Received content for: ${data.sectionName}`);
        
        if (contentArea) {
          contentArea.innerHTML = `
            <div class="content-header">
              <button class="back-button" onclick="showMainDashboard()">‚Üê Course Dashboard</button>
              <h1>Section ${data.sectionNumber}: ${data.sectionName}</h1>
            </div>
            <div class="content-body">
              ${data.content}
            </div>
          `;
        }
        
        console.log(`‚úÖ Content displayed successfully for section ${sectionId}`);
        
      } catch (error) {
        console.error('üí• Error loading section content:', error);
        
        const contentArea = document.getElementById('contentArea');
        if (contentArea) {
          contentArea.innerHTML = `
            <div class="content-header">
              <button class="back-button" onclick="showMainDashboard()">‚Üê Course Dashboard</button>
              <h1>Error Loading Content</h1>
            </div>
            <div class="error-message">
              <p>Failed to load section content. Please try again.</p>
              <p style="color: #666; font-size: 12px;">Error: ${error.message}</p>
              <button onclick="showDatabaseContent(${sectionId})" class="retry-button">Retry</button>
            </div>
          `;
        }
      }
    }

    // Show main dashboard
    function showMainDashboard() {
      console.log('üè† Returning to main dashboard');
      showHome();
      console.log('‚úÖ Returned to main dashboard');
    }

    function getContentForSection(id) {

      return ""
    }

    // Database-driven quiz functions
    let currentQuizData = null;
    let currentQuizProgress = null;
    let activeCourseId = null;
    let currentSectionId = null;
    const sectionNameMap = {};

    // Retake quiz functionality - using custom DHTML modal
    var pendingRetakeQuizId = null;
    var pendingRetakeSectionId = null;
    
    window.retakeQuiz = function retakeQuiz(quizId) {
      console.log('üîÑ Retake Quiz clicked for quiz ID:', quizId);
      pendingRetakeQuizId = quizId;
      pendingRetakeSectionId = currentQuizId;
      showRetakeModal();
    }
    
    function showRetakeModal() {
      var modal = document.getElementById('retakeModal');
      if (modal) {
        modal.classList.add('active');
        console.log('üì¢ Retake modal shown');
      } else {
        console.error('‚ùå Retake modal not found');
      }
    }
    
    function hideRetakeModal() {
      var modal = document.getElementById('retakeModal');
      if (modal) {
        modal.classList.remove('active');
        console.log('üì¢ Retake modal hidden');
      }
    }
    
    window.cancelRetakeQuiz = function cancelRetakeQuiz() {
      console.log('‚ùå User cancelled retake');
      pendingRetakeQuizId = null;
      hideRetakeModal();
    }
    
    window.confirmRetakeQuiz = async function confirmRetakeQuiz() {
      console.log('‚úÖ User confirmed retake');
      hideRetakeModal();
      await performDatabaseRetake();
    }
    
    async function performDatabaseRetake() {
      var quizId = pendingRetakeQuizId;
      var sectionId = pendingRetakeSectionId;
      console.log('üîÑ Performing database retake for quiz:', quizId, 'section:', sectionId);
      
      var authToken = localStorage.getItem('authToken');
      
      try {
        const response = await fetch('/api/quiz/' + quizId + '/progress', {
          method: 'DELETE',
          headers: {
            'X-Auth-Token': authToken
          }
        });
        console.log('üì° Response:', response.status);
      } catch (e) {
        console.error('‚ùå Fetch error:', e);
      }
      
      // Reset local state
      pendingRetakeQuizId = null;
      pendingRetakeSectionId = null;
      
      // Reset current quiz progress
      currentQuizProgress = {
        user_answers: {},
        current_question: 0,
        progress: 0,
        is_completed: false
      };
      currentQIndex = 0;
      
      // Update the quiz label immediately to show reset
      var quizLabel = document.getElementById('quizLabel' + sectionId);
      if (quizLabel && currentQuizData && currentQuizData.questions) {
        quizLabel.textContent = 'Quiz (0 / ' + currentQuizData.questions.length + ' Correct)';
        quizLabel.classList.remove('passed', 'failed', 'in-progress');
        quizLabel.classList.add('not-started');
      }
      
      // Reload the same section quiz instead of reloading the page
      if (sectionId) {
        console.log('üîÑ Reloading section quiz:', sectionId);
        await loadQuizFromDatabase(sectionId);
        
        // Update global statistics from server AFTER quiz is reloaded
        await updateGlobalDisplay();
        
        // Update floating button visibility based on new score
        const authToken = localStorage.getItem('authToken');
        const progressUrl = `/api/user/course-progress?courseId=${activeCourseId || 1}`;
        const progressResponse = await fetch(progressUrl, {
          headers: authToken ? { 'X-Auth-Token': authToken } : {},
          credentials: 'include'
        });
        
        if (progressResponse.ok) {
          const progressData = await progressResponse.json();
          const totalCorrect = progressData.overall.total_score;
          const totalPossible = progressData.overall.total_questions;
          const pct = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
          
          const floatingSubmitBtn = document.getElementById('floatingSubmitBtn');
          if (floatingSubmitBtn) {
            floatingSubmitBtn.style.display = pct >= PASSING_PERCENTAGE ? 'block' : 'none';
            console.log(`üîò Floating button ${pct >= PASSING_PERCENTAGE ? 'shown' : 'hidden'} - score: ${pct}%`);
          }
        }
      } else {
        // Fallback to page reload if section ID is not available
        window.location.reload();
      }
    }
    
    // Test function to verify retake functions are loaded
    function testRetakeFunctions() {
      console.log('üß™ Testing retake functions...');
      console.log('retakeQuiz function exists:', typeof retakeQuiz === 'function');
    }

    // Make test function globally available
    window.testRetakeFunctions = testRetakeFunctions;

    function updateOverallProgressDisplay(overallProgress) {
      console.log('üìä Updating overall progress display:', overallProgress);
      
      // Update header with overall progress
      const header = document.querySelector('header h1');
      if (header && overallProgress) {
        const originalText = 'Brooklyn CDL ELDT Training';
        const progressText = `${originalText} - Overall: ${overallProgress.sections_completed}/${overallProgress.total_sections} sections (${overallProgress.overall_percentage}%)`;
        header.textContent = progressText;
        
        // Add progress indicator class
        if (overallProgress.passed) {
          header.className = 'progress-passed';
        } else if (overallProgress.overall_percentage > 0) {
          header.className = 'progress-in-progress';
        } else {
          header.className = 'progress-not-started';
        }
      }
      
      // Update or create progress summary in home content
      const homeContent = document.querySelector('#home');
      if (homeContent && overallProgress) {
        let progressSummary = homeContent.querySelector('.progress-summary');
        if (!progressSummary) {
          progressSummary = document.createElement('div');
          progressSummary.className = 'progress-summary';
          homeContent.appendChild(progressSummary);
        }
        
        const passedClass = overallProgress.passed ? 'passed' : '';
        progressSummary.innerHTML = `
          <div class="overall-progress ${passedClass}">
            <h3>Course Progress Summary</h3>
            <div class="progress-stats">
              <div class="stat">
                <span class="stat-label">Sections Completed:</span>
                <span class="stat-value">${overallProgress.sections_completed}/${overallProgress.total_sections}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Overall Score:</span>
                <span class="stat-value">${overallProgress.total_score}/${overallProgress.total_questions} (${overallProgress.overall_percentage}%)</span>
              </div>
              <div class="stat">
                <span class="stat-label">Course Status:</span>
                <span class="stat-value ${overallProgress.passed ? 'passed' : 'not-passed'}">
                  ${overallProgress.passed ? '‚úÖ PASSED' : 'üìö In Progress'}
                </span>
              </div>
            </div>
          </div>
        `;
      }
    }

    async function loadCourseFromDatabase() {
      try {
        console.log('üîÑ Loading course from database...');
        
        const authToken = localStorage.getItem('authToken');
        const requestOptions = {
          credentials: 'include'
        };
        
        if (authToken) {
          requestOptions.headers = {
            'X-Auth-Token': authToken
          };
        }
        
        const coursesResponse = await fetch('/api/user/courses', requestOptions);
        console.log('üì° Courses response status:', coursesResponse.status);
        
        if (coursesResponse.ok) {
          const courses = await coursesResponse.json();
          console.log('üìö Found courses:', courses);
          
          if (courses.length > 0) {
            const courseId = courses[0].id; // Use first assigned course
            console.log('üéØ Loading sections for course:', courseId);
            await loadCourseSections(courseId);
          } else {
            console.log('‚ùå No courses found for user');
          }
        } else {
          console.error('‚ùå Failed to fetch courses:', coursesResponse.statusText);
        }
      } catch (error) {
        console.error('üí• Error loading course data:', error);
        console.error('üí• Error details:', error.message, error.stack);
      }
    }

    async function loadCourseSections(courseId) {
      try {
        console.log('üîç Loading course sections for course ID:', courseId);
        activeCourseId = courseId;
        
        const authToken = localStorage.getItem('authToken');
        const requestOptions = {
          credentials: 'include',
          cache: 'no-cache'  // Force fresh request
        };
        
        if (authToken) {
          requestOptions.headers = {
            'X-Auth-Token': authToken,
            'Cache-Control': 'no-cache'
          };
        } else {
          requestOptions.headers = {
            'Cache-Control': 'no-cache'
          };
        }
        
        console.log('üì° Making request to /api/course/' + courseId + '/sections');
        console.log('üì° Request options:', requestOptions);
        
        const response = await fetch(`/api/course/${courseId}/sections`, requestOptions);
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', response.headers);
        
        if (response.ok) {
          const data = await response.json();
          console.log('üìö Received sections data:', data);
          console.log('üìö Data type:', typeof data);
          console.log('üìö Data is array:', Array.isArray(data));
          console.log('üìö Data length:', data.length);
          
          // The API returns the sections array directly, not wrapped in an object
          const sections = Array.isArray(data) ? data : data.sections;
          
          if (!sections || !Array.isArray(sections) || sections.length === 0) {
            console.warn('‚ö†Ô∏è No sections returned from API');
            console.warn('‚ö†Ô∏è Full response data:', JSON.stringify(data, null, 2));
            throw new Error('No course sections available');
          }
          
          // Load course progress
          let courseProgress = null;
          try {
            const progressUrl = `/api/user/course-progress?courseId=${courseId}`;
            const progressResponse = await fetch(progressUrl, {
              headers: authToken ? { 'X-Auth-Token': authToken } : {}
            });
            if (progressResponse.ok) {
              courseProgress = await progressResponse.json();
              console.log('üìä Course progress loaded:', courseProgress);
            } else {
              console.log('‚ö†Ô∏è Progress API returned error:', progressResponse.status);
            }
          } catch (progressError) {
            console.log('‚ö†Ô∏è Could not load progress data:', progressError.message);
            // Continue without progress data
            courseProgress = null;
          }
          
          // Update the sidebar navigation with database sections
          const nav = document.getElementById('sidebarNav');
          if (!nav) {
            console.error('‚ùå Sidebar navigation element (#sidebarNav) not found!');
            throw new Error('Navigation element not found');
          }
          
          console.log('üéØ Found sidebar element:', nav);
          
          let navHtml = '';
          
          sections.forEach((section, index) => {
            sectionNameMap[section.id] = section.section_name;
            // Find progress for this section
            const sectionProgress = courseProgress && courseProgress.sections ? 
              courseProgress.sections.find(p => p.section_id === section.id) : null;
            
            let progressText = 'Not Started';
            let progressClass = 'not-started';
            let scoreText = '';
            
            if (sectionProgress) {
              if (sectionProgress.is_completed) {
                const scorePercentage = sectionProgress.score && sectionProgress.total_questions > 0 
                  ? Math.round((sectionProgress.score / sectionProgress.total_questions) * 100) 
                  : 0;
                progressText = `Completed (${scorePercentage}%)`;
                progressClass = scorePercentage >= PASSING_PERCENTAGE ? 'passed' : 'failed';
                scoreText = ` - Score: ${sectionProgress.score || 0}/${sectionProgress.total_questions || 0}`;
              } else if (sectionProgress.progress_percentage > 0) {
                progressText = `In Progress (${sectionProgress.progress_percentage}%)`;
                progressClass = 'in-progress';
              }
            }
            
            console.log(`üè∑Ô∏è Processing section ${index + 1}:`, section.section_name, '- Progress:', progressText);
            navHtml += `
              <div class="nav-item" onclick="toggleMenu('m${section.id}')">${section.section_name}</div>
              <div id="m${section.id}" class="sub-menu">
                <div class="sub-item" onclick="showDatabaseContent(${section.id}); closeMobileMenu();">Study Content</div>
                <div id="quizLabel${section.id}" class="sub-item quiz-progress ${progressClass}" onclick="loadQuizFromDatabase(${section.id}); closeMobileMenu();">
                  Quiz: ${progressText}${scoreText}
                </div>
              </div>
            `;
          });
          
          console.log('‚úÖ Generated HTML:', navHtml);
          nav.innerHTML = navHtml;
          console.log('‚úÖ Sidebar updated successfully');
          
          // Update overall progress display if available
          if (courseProgress && courseProgress.overall) {
            updateOverallProgressDisplay(courseProgress.overall);
            // Also update the global display with server data
            await updateGlobalDisplay();
          }
          
        } else {
          const errorText = await response.text();
          console.error('‚ùå Error response:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
      } catch (error) {
        console.error('üí• Error loading course sections:', error);
        console.error('üí• Error details:', error.message, error.stack);
        console.error('üí• Error type:', typeof error);
        
        // Show error to user
        const nav = document.getElementById('sidebarNav');
        if (nav) {
          nav.innerHTML = `
            <div class="nav-item error-message">
              ‚ùå Error Loading Course Sections
            </div>
            <div class="nav-item error-message" style="font-size: 12px;">
              ${error.message}
            </div>
            <div class="nav-item">
              <button onclick="loadCourseSections(${courseId})">üîÑ Retry</button>
            </div>
          `;
        }
        
        // Note: Removed automatic fallback to prevent infinite loop
        console.log('‚ùå Course sections could not be loaded');
      }
    }

    async function loadQuizFromDatabase(sectionId) {
      try {
        console.log(`üéØ [QUIZ] Loading quiz for section ${sectionId}`);
        
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          console.error('‚ùå [QUIZ] No authentication token found');
          alert('Please log in again to access quizzes.');
          return;
        }
        
        const requestOptions = {
          credentials: 'include',
          headers: {
            'X-Auth-Token': authToken,
            'Cache-Control': 'no-cache'
          }
        };
        
        console.log(`üì° [QUIZ] Fetching from /api/section/${sectionId}/quiz`);
        console.log('üì° [QUIZ] Request options:', requestOptions);
        
        const response = await fetch(`/api/section/${sectionId}/quiz`, requestOptions);
        
        console.log(`üì° [QUIZ] Response status: ${response.status}`);
        
        if (response.ok) {
          const quizData = await response.json();
          console.log(`‚úÖ [QUIZ] Quiz data received:`, quizData);
          console.log(`‚úÖ [QUIZ] Section name:`, quizData.sectionName);
          
          currentQuizId = sectionId;
          currentSectionId = sectionId;
          currentQuizData = quizData;
          const derivedSectionName = quizData.sectionName || sectionNameMap[sectionId] || '';
          currentQuizData.sectionName = derivedSectionName;
          currentQuizProgress = quizData.progress || { current_question: 0, user_answers: {} };
          
          // Calculate the next unanswered question based on user_answers
          let nextQuestionIndex = 0;
          let allQuestionsAnswered = false;
          if (currentQuizProgress.user_answers) {
            const userAnswers = typeof currentQuizProgress.user_answers === 'string' 
              ? JSON.parse(currentQuizProgress.user_answers) 
              : currentQuizProgress.user_answers;
            
            console.log('üìù [QUIZ] User answers found:', userAnswers);
            
            allQuestionsAnswered = true;
            for (let i = 0; i < quizData.questions.length; i++) {
              const questionId = quizData.questions[i].id;
              if (userAnswers[questionId] === undefined) {
                nextQuestionIndex = i;
                allQuestionsAnswered = false;
                break;
              }
            }
            
            if (allQuestionsAnswered) {
              nextQuestionIndex = quizData.questions.length;
            }
            
            console.log(`üîç [QUIZ] Next unanswered question index: ${nextQuestionIndex}`);
          }
          
          currentQIndex = nextQuestionIndex;
          if (allQuestionsAnswered) {
            currentQuizProgress.is_completed = true;
          }
          
          console.log(`üéØ [QUIZ] Starting at question ${currentQIndex + 1}`);
          renderQuizStepFromDatabase();
          
          // Update global display to show submit button if score >= 80%
          await updateGlobalDisplay();
          
          // Show floating button in quiz view if score >= 80%
          const progressUrl = `/api/user/course-progress?courseId=${activeCourseId || 1}`;
          const progressResponse = await fetch(progressUrl, {
            headers: authToken ? { 'X-Auth-Token': authToken } : {},
            credentials: 'include'
          });
          
          if (progressResponse.ok) {
            const progressData = await progressResponse.json();
            const totalCorrect = progressData.overall.total_score;
            const totalPossible = progressData.overall.total_questions;
            const pct = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
            
            const floatingSubmitBtn = document.getElementById('floatingSubmitBtn');
            if (floatingSubmitBtn) {
              floatingSubmitBtn.style.display = pct >= PASSING_PERCENTAGE ? 'block' : 'none';
            }
          }
        } else {
          const errorText = await response.text();
          console.error(`üí• [QUIZ] API Error (${response.status}):`, errorText);
          alert(`Quiz not found for this section. Error: ${response.status}`);
        }
      } catch (error) {
        console.error('üí• [QUIZ] Error loading quiz:', error);
        alert(`Error loading quiz: ${error.message}. Please try again.`);
      }
    }

    function renderQuizStepFromDatabase() {
      if (!currentQuizData || !currentQuizData.questions) return;
      
      const questions = currentQuizData.questions;
      if (!questions.length) {
        console.warn('‚ö†Ô∏è [QUIZ] No questions available to render');
        return;
      }
      if (currentQuizProgress && (currentQuizProgress.is_completed || currentQIndex >= questions.length)) {
        renderQuizCompletionSummary();
        return;
      }
      const q = questions[currentQIndex];
      const progress = ((currentQIndex + 1) / questions.length) * 100;

      document.getElementById('contentArea').innerHTML = `
        <div class="quiz-card">
          <div class="quiz-header">
            ${currentQuizData.sectionName ? `
              <div style="width: 100%; text-align: center; margin-bottom: 4px;">
                <span style="font-size: 1.05rem; color: var(--primary); font-weight: 700; letter-spacing: 0.4px;">${currentQuizData.sectionName}</span>
              </div>
            ` : ''}
            <div style="display: flex; align-items: center; width: 100%; gap: 12px; flex-wrap: nowrap;">
              <span style="font-weight: 600; flex: 1; font-size: 0.95rem;">Question ${currentQIndex + 1}/${questions.length}</span>
              <div style="flex: 0 0 auto; display: flex; justify-content: center; min-width: 130px;">
                <button class="btn btn-warning" onclick="retakeQuiz(${currentQuizData.quizId})">Retake Quiz</button>
              </div>
              <div style="flex: 1; display: flex; justify-content: flex-end; min-width: 160px;">
                <div class="progress-bar" style="margin: 0; width: 180px; max-width: 100%;"><div class="progress-fill" style="width:${progress}%"></div></div>
              </div>
            </div>
          </div>
          <div style="padding:18px 20px">
            <h3>${q.question_name}</h3>
            <div id="quizForm">${q.choices.map(choice => `
              <label class="option">
                <input type="radio" name="ans" value="${choice.choice_name}"> 
                <span>${choice.choice_description}</span>
              </label>
            `).join('')}</div>
            <div id="feedback" class="feedback" style="display:none"></div>
          </div>
          <div style="padding:14px 18px; border-top:1px solid var(--border); display:flex; justify-content:space-between; flex-wrap: wrap; gap: 6px">
            <button class="back-button" onclick="showHome()">‚Üê Course Dashboard</button>
            <div style="display: flex; gap: 6px; flex-wrap: wrap">
               <button id="subBtn" class="back-button" onclick="submitAnswerDatabase()">Submit Answer ‚Üí</button>
               <button id="nextBtn" class="back-button" style="display:none" onclick="nextQuestionDatabase()">Next Question ‚Üí</button>
            </div>
          </div>
        </div>`;
      
      // Restore previous answer if available
      if (currentQuizProgress.user_answers) {
        const userAnswers = typeof currentQuizProgress.user_answers === 'string' 
          ? JSON.parse(currentQuizProgress.user_answers) 
          : currentQuizProgress.user_answers;
        
        // Use the question id from the database
        const questionId = q.id;
        if (userAnswers[questionId]) {
          const radio = document.querySelector(`input[name="ans"][value="${userAnswers[questionId]}"]`);
          if (radio) radio.checked = true;
        }
      }
    }

    function renderQuizCompletionSummary(override = {}) {
      if (!currentQuizData || !document.getElementById('contentArea')) {
        return;
      }
      const questions = currentQuizData.questions || [];
      const totalQuestions = questions.length || override.totalQuestions || 0;
      const score = override.score ?? currentQuizProgress.score ?? 0;
      const percentage = override.percentage ?? (totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0);
      const passed = percentage >= PASSING_PERCENTAGE;
      currentQuizProgress.is_completed = true;
      document.getElementById('contentArea').innerHTML = `
        <div class="quiz-card" style="padding:24px; text-align:center;">
          <h2 style="margin-bottom:20px;">Section Complete</h2>
          ${currentQuizData.sectionName ? `<p style="margin-bottom:10px; color: var(--muted);">${currentQuizData.sectionName}</p>` : ''}
          <div style="margin: 30px 0;">
            <div style="font-size: 3rem; margin: 20px 0; color: ${passed ? 'var(--accent)' : 'var(--danger)'}">${percentage}%</div>
            <p>Score: ${score} / ${totalQuestions}</p>
            <p>${passed ? 'üéâ Congratulations! This section is passed.' : 'üìö Keep practicing and retake the section.'}</p>
            <p style="color: #666; font-size: 14px; margin-top: 20px;">üìä Your answers are saved in the system.</p>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button class="back-button" onclick="showHome();">‚Üê Course Dashboard</button>
            <button class="back-button" onclick="retakeQuiz(${currentQuizData.quizId})">Retake Quiz ‚Üí</button>
          </div>
        </div>`;
    }

    async function submitAnswerDatabase() {
      const selected = document.querySelector('input[name="ans"]:checked');
      if (!selected) return alert("Please select an option.");

      const questions = currentQuizData.questions;
      const q = questions[currentQIndex];
      const correctChoice = q.choices.find(choice => choice.is_correct);
      const isCorrect = selected.value === correctChoice.choice_name;

      // Update user answers
      let userAnswers = currentQuizProgress.user_answers || {};
      if (typeof userAnswers === 'string') {
        userAnswers = JSON.parse(userAnswers);
      }
      // Use the question id from the database, not the array index
      const questionId = q.id;
      userAnswers[questionId] = selected.value;

      // Calculate progress
      const progress = Math.round(((currentQIndex + 1) / questions.length) * 100);
      const isCompleted = currentQIndex >= questions.length - 1;

      // Save progress to database
      try {
        const authToken = localStorage.getItem('authToken');
        await fetch(`/api/quiz/${currentQuizData.quizId}/progress`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Auth-Token': authToken
          },
          body: JSON.stringify({
            currentQuestion: currentQIndex,
            userAnswers: userAnswers,
            progress: progress,
            isCompleted: isCompleted
          })
        });

        // Update local progress
        currentQuizProgress.user_answers = userAnswers;
        currentQuizProgress.progress = progress;
        currentQuizProgress.current_question = currentQIndex;
        
        // Refresh global progress statistics
        await updateGlobalDisplay();
        
        // Update floating button visibility based on current score
        const progressUrl = `/api/user/course-progress?courseId=${activeCourseId || 1}`;
        const progressResponse = await fetch(progressUrl, {
          headers: authToken ? { 'X-Auth-Token': authToken } : {},
          credentials: 'include'
        });
        
        if (progressResponse.ok) {
          const progressData = await progressResponse.json();
          const totalCorrect = progressData.overall.total_score;
          const totalPossible = progressData.overall.total_questions;
          const pct = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
          
          const floatingSubmitBtn = document.getElementById('floatingSubmitBtn');
          if (floatingSubmitBtn) {
            floatingSubmitBtn.style.display = pct >= PASSING_PERCENTAGE ? 'block' : 'none';
            console.log(`üîò Floating button ${pct >= PASSING_PERCENTAGE ? 'shown' : 'hidden'} after answer - score: ${pct}%`);
          }
        }
      } catch (error) {
        console.error('Error saving progress:', error);
      }

      // Show feedback
      document.getElementById('feedback').style.display = 'block';
      document.getElementById('feedback').innerHTML = isCorrect ? "‚úì Correct" : "‚úó Incorrect";
      document.getElementById('feedback').className = "feedback " + (isCorrect ? "correct" : "incorrect");

      document.getElementById('subBtn').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'inline-block';
    }

    function nextQuestionDatabase() {
      const questions = currentQuizData.questions;
      
      if (currentQIndex < questions.length - 1) {
        currentQIndex++;
        renderQuizStepFromDatabase();
      } else {
        // Quiz completed - calculate final score and submit
        finishQuizDatabase();
      }
    }

    async function finishQuizDatabase() {
      try {
        const questions = currentQuizData.questions;
        let userAnswers = currentQuizProgress.user_answers || {};
        if (typeof userAnswers === 'string') {
          userAnswers = JSON.parse(userAnswers);
        }

        // Calculate score - use question id from database, not array index
        let score = 0;
        for (let i = 0; i < questions.length; i++) {
          const q = questions[i];
          const correctChoice = q.choices.find(choice => choice.is_correct);
          // Use question id instead of array index i
          if (userAnswers[q.id] === correctChoice.choice_name) {
            score++;
          }
        }

        // Submit final results
        const authToken = localStorage.getItem('authToken');
        const submitResponse = await fetch(`/api/quiz/${currentQuizData.quizId}/submit`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Auth-Token': authToken
          },
          body: JSON.stringify({
            userAnswers: userAnswers,
            score: score,
            totalQuestions: questions.length
          })
        });

        if (submitResponse.ok) {
          const result = await submitResponse.json();
          
          // Refresh the course progress to show updated scores
          console.log('üîÑ Refreshing course progress after quiz completion');
          await loadCourseFromDatabase();
          
          // Update global display to immediately show submit scores button if score >= 80%
          await updateGlobalDisplay();
          
          currentQuizProgress.score = result.score;
          currentQuizProgress.is_completed = true;
          currentQIndex = questions.length;
          renderQuizCompletionSummary({
            score: result.score,
            totalQuestions: questions.length,
            percentage: result.percentage
          });
        }
      } catch (error) {
        console.error('Error submitting quiz:', error);
        alert("Error submitting quiz results. Please try again.");
      }
    }

    // All quiz functions are now database-driven

    async function updateGlobalDisplay() {
      try {
        // Get progress data from server instead of using client-side calculations
        const authToken = localStorage.getItem('authToken');
        const requestOptions = {
          credentials: 'include'
        };
        
        if (authToken) {
          requestOptions.headers = {
            'X-Auth-Token': authToken
          };
        }
        
        let progressUrl = '/api/user/course-progress';
        if (activeCourseId) {
          progressUrl += `?courseId=${activeCourseId}`;
        }
        const progressResponse = await fetch(progressUrl, requestOptions);
        
        if (progressResponse.ok) {
          const progressData = await progressResponse.json();
          console.log('üìä Using server-side progress data for global display:', progressData);
          
          const totalCorrect = progressData.overall.total_score;
          const totalPossible = progressData.overall.total_questions; 
          const totalAttempted = progressData.overall.total_attempted;
          
          // Update global displays with server data
          const globalCountEl = document.getElementById('globalCount');
          globalCountEl.textContent = `${totalCorrect} / ${totalPossible} Correct`;
          
          const pct = totalPossible > 0 ? Math.round((totalCorrect / totalPossible) * 100) : 0;
          
          // Apply color to Overall Score - white/inherit by default, green when passed
          if (pct >= PASSING_PERCENTAGE && totalAttempted >= totalPossible) {
            globalCountEl.style.color = 'var(--accent)';
          } else {
            globalCountEl.style.color = 'inherit';
          }
          
          const pctEl = document.getElementById('pctBox');
          pctEl.textContent = pct + "%";
          
          document.getElementById('attemptedBox').textContent = `Total Attempted: ${totalAttempted}`;
          
          if (totalAttempted >= (progressData.overall.total_sections * 0.8)) {
            pctEl.style.color = (pct >= PASSING_PERCENTAGE) ? 'var(--accent)' : 'var(--danger)';
          } else {
            pctEl.style.color = 'inherit';
          }
          
          // Show Submit Scores button if percentage is PASSING_PERCENTAGE% or higher
          const submitScoresBtn = document.getElementById('submitScoresBtn');
          const certificateBtn = document.getElementById('certificateBtn');
          
          if (submitScoresBtn) {
            if (pct >= PASSING_PERCENTAGE) {
              submitScoresBtn.style.display = 'block';
            } else {
              submitScoresBtn.style.display = 'none';
            }
          }
          
          // Certificate button visibility is controlled separately
          // Note: Floating button visibility is controlled in quiz rendering functions
          
          // Show Certificate button if percentage is PASSING_PERCENTAGE% or higher (passed)
          if (certificateBtn) {
            if (pct >= PASSING_PERCENTAGE && totalAttempted >= totalPossible) {
              certificateBtn.style.display = 'block';
            } else {
              certificateBtn.style.display = 'none';
            }
          }
          
          // Update individual quiz labels with server data
          progressData.sections.forEach(section => {
            const label = document.getElementById(`quizLabel${section.quiz_id}`);
            if (label) {
              label.textContent = `Quiz (${section.score} / ${section.total_questions} Correct)`;
              // Apply color class based on progress
              label.classList.remove('passed', 'failed', 'in-progress', 'not-started');
              if (section.is_completed) {
                const scorePercentage = section.total_questions > 0 ? (section.score / section.total_questions) * 100 : 0;
                label.classList.add(scorePercentage >= PASSING_PERCENTAGE ? 'passed' : 'failed');
              } else if (section.progress_percentage > 0) {
                label.classList.add('in-progress');
              } else {
                label.classList.add('not-started');
              }
            }
          });
          
        } else {
          console.log('‚ö†Ô∏è Could not get progress data from server');
        }
        
      } catch (error) {
        console.error('‚ùå Error fetching progress data:', error);
      }
    }

    window.onload = function() {
      // Check for bypass parameter in URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('bypass') === 'demo') {
        // Set up demo user data
        userData.firstName = 'Admin';
        userData.lastName = 'Test';
        userData.dob = '1990-01-01';
        userData.licenseNumber = '123456789';
        userData.state = 'US-NY';
        userData.email = 'demo@example.com';
        userData.phone = '123-555-0123';
        userData.registerDate = new Date().toISOString();
        userData.startDate = new Date().toISOString();
        
        // Ensure DOM is fully ready before initializing
        setTimeout(() => {
          const navElement = document.getElementById('sidebarNav');
          const contentArea = document.getElementById('contentArea');
          
          if (navElement && contentArea) {
            // Show sidebar and UI elements (same as normal registration)
            document.getElementById('sidebar').style.display = 'flex';
            // Only show menu toggle on mobile/tablet
            if (window.innerWidth <= 768) {
              document.querySelector('.menu-toggle').style.display = 'block';
            }
            
            // Initialize the sidebar and show home
            initSidebar();
            console.log('Demo mode activated - Registration bypassed');
          }
        }, 100); // Small delay to ensure DOM is ready
      }
    };

    // Handle window resize to show/hide menu button appropriately
    window.addEventListener('resize', function() {
      const menuToggle = document.querySelector('.menu-toggle');
      if (menuToggle) {
        if (window.innerWidth <= 768) {
          // Show menu button on mobile/tablet
          if (document.getElementById('sidebar').style.display === 'flex') {
            menuToggle.style.display = 'block';
          }
        } else {
          // Hide menu button on desktop
          menuToggle.style.display = 'none';
          // Also close mobile menu if it's open
          document.getElementById('sidebar').classList.remove('mobile-open');
        }
      }
    });
  </script>
</body>
</html>
